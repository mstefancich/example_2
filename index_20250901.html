<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {box-sizing: border-box}

/* Set height of body and the document to 100% */
body, html {
  height: 100%;
  margin: 0;
  font-family: Arial;
}

/* Style tab links */
/* width must be 50% if two tabs only are present but 3 in AP mode */
.tablink {
  background-color: #555;
  color: white;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  font-size: 17px;
  width: 33%;
}

.tablink:hover {
  background-color: #777;
}

/* Style the tab content (and add height:100% for full page content) */
.tabcontent {
  color: white;
  display: none;
  padding: 50px 20px;
  height: 100%;
}

#Control {background-color: #ABB2B9 ;} /* old color #E688F5 */
#Print {background-color: #B2BABB;} /* old color #25BC91 */
/* #Contact {background-color: blue;} */
/* #About {background-color: orange;} */

table { 
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 50%;
  position: relative;
  left: 100px;
}

td, th {
  text-align: center;
  padding: 6px;
  border: 1px solid #2E86C1;
  border: none
}

textarea {
  resize: none;
  text-align: center;
}

h2 {
  text-align: center;
  padding: 8px;
}

h3 {
  color: black;
}

.small_button {
  font-size: 16px;
  text-align: center;
  vertical-align: middle;
  color: white;
  border: 20px;
  background-color: #58D68D;
  height:30px;
  width: 115px;
}

.small_button:hover {
  background-color: #3498DB;
}

.mid_button {
  border: none;
  color: white;
  padding: 25px 42px;
  text-align: center;
  vertical-align: middle;
  text-decoration: none;
  display: inline-block;
  font-size: 20px;
  margin: 6px 12px;
  cursor: pointer;
  background-color: #58D68D;
}  

.button {
  border: none;
  color: white;
  padding: 25px 42px;
  text-align: center;
  vertical-align: middle;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 6px 12px;
  cursor: pointer;
}

.button:hover {
  background-color: #3498DB;
}

.button:disabled {
  background-color: #EBEDEF;
}

}
.button1 {background-color: #04AA6D;} /* Green */
.button2 {background-color: #008CBA;} /* Blue */
.button3 {background-color: Tomato;}

.grid-container {
  display: grid;
  text-align: center;
  vertical-align: middle;
  grid-template-columns: 30% 13% 13% 13% 30%;
}

.container { 
  height: 200px;
  position: relative;
  border: 3px solid green; 
  margin: 5px;
}
.container1 { 
  height: 100px;
  position: relative;
  border: 3px solid green; 
}

.switch {
  position: relative;
  display: inline-block;
  width: 80px;
  height: 24px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 19px;
  width: 19px;
  left: 8px;
  bottom: 2px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
  value:"ON";
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(46px);
  -ms-transform: translateX(46px);
  transform: translateX(46px);
  value:"OFF" ;
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}


/* Added on August 11th 2025 for the WiFi selection window */
/* select, input { padding: 6px; font-size: 1rem; margin-top: 4px; } */
/* button { margin-top: 12px; padding: 8px 12px; font-size: 1rem; } */


</style>

</head>
<body>
<button class="tablink" onclick="openPage('Control', this, '#ABB2B9')" id="defaultOpen">Control</button>
<button class="tablink" onclick="openPage('Print', this, '#B2BABB')">Print</button>
<button class="tablink" onclick="openPage('WiFi', this, 'orange')">WiFi</button>
<!-- <button class="tablink" onclick="openPage('Contact', this, 'blue')">Contact</button> -->
<!-- <button class="tablink" onclick="openPage('About', this, 'orange')">About</button> -->

<div id="Control" class="tabcontent">
    <h2>
		<div class="grid-container" style="grid-template-columns: 50% 50%;">
		<div>Electrical Values</div>
		<div>Generator Controls</div>
		</div>
    </h2>
    <div class="grid-container" style="grid-template-columns: 3% 50% 40%;"> 
		<div></div>
        <div> <!-- contains the electrical values table -->
            <table>
			  <tr><th></th></tr>
              <tr>
                <th>
					<textarea id="Current" name="Current" rows="3" cols="15">              [0.0, 0.0] mA </textarea>
				</th>
                 <th>
					<textarea id="HV_Voltage" name="HV_Voltage" rows="3" cols="15">              [0.0, 0.0] V </textarea>
				</th>
                <th>
					<textarea id="DR_Voltage" name="DR_Voltage" rows="3" cols="15">              [0.0, 0.0] V </textarea>
				</th>
			  </tr>
			</table>
		</div>
        <div> <!-- contains the generator controls -->
            <table>
              <tr>
                <th></th>
                <th> <input type="range" id="CURRENTSET" min="0" max="100" value="10"> </th>
                <th> <p>Iout: <span id="CURRENTSETINDICATOR"></span></p> </th>
                <th></th>
              </tr>
              <tr>
                <th><label class="switch">
                  <input type="checkbox" checked id="GENVOLT">
                  <span class="slider round"></span>
                </label>
                </th>
                <th>
                <p id="Gtext" style="display:block ; text-align:left">200 V</p>
                <p id="Gtext1" style="display:none ; text-align:left">130 V</p>
                </th>
                <th><label class="switch">
                  <input type="checkbox" id="GENSTATE">
                  <span class="slider round"></span>
                </label>
                </th>
                <th>
                <p id="Gtext2" style="display:none ; text-align:left">ON</p>
                <p id="Gtext3" style="display:block ; text-align:left">OFF</p></th>
              </tr>
            </table>
        </div>
    </div>
	
    <h2>
    <div class="grid-container" style="grid-template-columns: 50% 50%;">
    <div>Printer Controls </div>
    <div>Pump Controls</div>
    </div>
    </h2>

    <div class="grid-container" style="grid-template-columns: 32% 20% 1% 40%;">
        <div>
            <table>
              <tr>
                <th></th>
                <th><button class="small_button" id="PRINTER_BACK">BACK</button></th>
                <th></th>
              </tr>
              <tr>
                <td><button class="small_button" id="PRINTER_LEFT">LEFT</button></td>
                <td><button class="small_button" id="PRINTER_HOMEXY">HOME XY</button></td>
                <td><button class="small_button" id="PRINTER_RIGHT">RIGHT</button></td>
              </tr>
              <tr>
                <td></td>
                <td><button class="small_button" id="PRINTER_FORWARD">FORWARD</button></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td><button class="small_button" id="PRINTER_SET_ZERO">SET ZERO</button></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td><button class="small_button" id="PRINTER_AUTO_ZERO">AUTO ZERO</button></td>
                <td></td>
              </tr>
            </table>
        </div>

        <div>
            <table>
              <tr>
                <th><button class="small_button" id="PRINTER_UP">UP</button></th>
              </tr>
              <tr>
                <th><button class="small_button" id="PRINTER_HOMEZ">HOME Z</button></th>
              </tr>
              <tr>
                <th><button class="small_button" id="PRINTER_DOWN">DOWN</button></th>
              </tr>
            </table>
        </div>

        <div></div>

        <div>
            <table>
              <tr>
                <th></th>
                <th> <input type="range" id="PUMPSPEED" min="1" max="100" value="50"> </th>
                <th> <p>Speed: <span id="PUMPSPEEDINDICATOR"></span></p> </th>
                <th></th>
              </tr>
              <tr>
                <th><label class="switch">
                  <input type="checkbox" checked id="PUMPDIR">
                  <span class="slider round"></span>
                </label>
                </th>
                <th>
                <p id="text" style="display:block ; text-align:left">FORWARD</p>
                <p id="text1" style="display:none ; text-align:left"">REVERSE</p>
                </th>
                <th><label class="switch">
                  <input type="checkbox" id="PUMPSTATE">
                  <span class="slider round"></span>
                </label>
                </th>
                <th>
                <p id="text2" style="display:none ; text-align:left">RUNNING</p>
                <p id="text3" style="display:block ; text-align:left">STOPPED</p></th>
              </tr>
            </table>
        </div>
    </div>
	<br>
	<form id="StepSelectorForm"> <!-- contains the printer steps size -->
    <div class="grid-container" style="grid-template-columns: 8% 10% 5% 5% 5% 5% 10%;"> 
		<div></div>
		<div>
			Move size (mm)
		</div>
		<div>
			<input type="radio" id="SizeA" name="Step" value="0.1" checked>
			<label for="SizeA">0.1</label><br>
		</div>
        <div> 
			  <input type="radio" id="SizeB" name="Step" value="1">
			  <label for="SizeB">1</label><br> 
		</div>
		<div>
			  <input type="radio" id="SizeC" name="Step" value="10">
			  <label for="SizeC">10</label><br>
		</div>
		<div>
			  <input type="radio" id="SizeD" name="Step" value="100">
			  <label for="SizeD">100</label><br><br>
		</div>
    </div>



</div>

<div id="Print" class="tabcontent">
    <h2>
    <div class="grid-container" style="grid-template-columns: 50% 50%;">
    <div>Files Upload </div>
    <div>Print</div>
    </div>
    </h2>

    <div class="grid-container" style="grid-template-columns: 30% 20% 5% 20% 25%;">
        <div>
            <input class="button button3" type="file" id="myFile" name="InFileName"/>
        </div>
        <div>
            <button class="button button3" style="font-size:21px;" id="UPLOAD">UPLOAD </button>
        </div>
        <div>
        </div>
        <div>
            <form onchange=send_selection()>
                  <label for="files">Select file to print:</label>
                  <select name="files"   width: 300px; id="PRINTABLEFILES">
                    <option id="V0" value="V0">Nothing Selected</option>
                    <option id="V1" value="V1">File_1</option>
                    <option id="V2" value="V2">File_2</option>
                    <option id="V3" value="V3">File_3</option>
                    <option id="V4" value="V4">File_4</option>                
                    <option id="V5" value="V5">File_5</option>                
                    <option id="V6" value="V6">File_6</option>                
                    <option id="V7" value="V7">File_7</option>                
                    <option id="V8" value="V8">File_8</option>                
                    <option id="V9" value="V9">File_9</option>                
                    <option id="V10" value="V10">File_10</option>                
                  </select>   
            </form> 
        </div>
        <div>
            <button type="button button3" disabled class="button button3" 
            id="STARTPRINT"> INITIATE PRINT </button>
            <button type="button button3" disabled class="button button3" 
            d="STOPPRINT"> STOP PRINT </button>
            <button type="button button3" disabled class="button button3" 
            id="ABORTPRINT"> ABORT PRINT </button>
            
        </div>
    </div>
</div>

<div id="WiFi" class="tabcontent">
  <h3>WiFi Selection</h3>
  <label for="ssidSelect">Wi‑Fi network (SSID)</label>
  <select id="ssidSelect">
    <option value="" selected disabled>Select a network</option>
  </select>

  <label for="password">Password</label>
  <input id="password" type="password" placeholder="Enter Wi‑Fi password" />

  <br>
  <button id="sendBtn">Send to device</button>

  <div id="status" style="margin-top: 12px;">Waiting…</div>

</div>

<div id="About" class="tabcontent">
  <h3>About</h3>
  <p>Nothing to see here.</p></div>

<div id="Contact" class="tabcontent">
  <h3>Contact</h3>
  <p>Get in touch, or swing by for a cup of coffee.</p>
</div>


<script>
<!-- let ws = new WebSocket("ws://raspberrypi2b.local:8080"); -->
const wsHost = window.location.hostname || "raspberrypi2b.local";
const wsPort = 8080;
const wsUrl = `ws://${wsHost}:${wsPort}`;
let ws = new WebSocket(wsUrl);

// ——— Helper: log lines to the UI
function log(msg) {
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  el.textContent = `[${time}] ${msg}\n` + el.textContent;
}

// this handles the request (in form of a GET from the pump to register its IP)

window.addEventListener("load", function () {
    console.log("load Event Listener triggered");
    // Assume your WebSocket connection is already created like:
    // const ws = new WebSocket("ws://raspberrypi2b.local:8080");

    // 1. Parse query string
    const params = new URLSearchParams(window.location.search);
    const msg = params.get("msg");
    const ip = params.get("ip");

    if (msg && ip) {
        const payload = {
            msg: msg,
            ip: ip
        };

        // 2. Wait for WebSocket to be open, then send
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(payload));
        } else {
            ws.addEventListener("open", () => {
                ws.send(JSON.stringify(payload));
            });
         }

        // 3. Optional: Show confirmation to user or log it
        console.log("Forwarded via WebSocket:", payload);
    } else {
        console.log("Missing query parameters in URL");
    }
});


function openPage(pageName,elmnt,color) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablink");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].style.backgroundColor = "";
  }
  document.getElementById(pageName).style.display = "block";
  elmnt.style.backgroundColor = color;
  
// Specific action for the WiFi tab, when the tab is selected, a request is sent
// to the backend with text “RequestWifiList” to get from it the list of available
// wifi networks for moving from AP to Wifi mode.
  if (pageName === "WiFi") {
    requestWifiList();
  }

}

// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();
// Setup the reaction functions for each page element
document.getElementById("STARTPRINT").onclick = send_data;
document.getElementById("PUMPSTATE").onclick = send_data;
document.getElementById("PUMPDIR").onclick = send_data;
document.getElementById("PUMPSPEED").onchange = send_data;
document.getElementById("GENSTATE").onclick = send_data;
document.getElementById("GENVOLT").onclick = send_data;
document.getElementById("CURRENTSET").onchange = send_data;
document.getElementById("PRINTABLEFILES").onchange = send_data;
document.getElementById("UPLOAD").onclick = send_data;
document.getElementById("PRINTER_UP").onclick = send_data;
document.getElementById("PRINTER_DOWN").onclick = send_data;
document.getElementById("PRINTER_HOMEZ").onclick = send_data;
document.getElementById("PRINTER_LEFT").onclick = send_data;
document.getElementById("PRINTER_RIGHT").onclick = send_data;
document.getElementById("PRINTER_FORWARD").onclick = send_data;
document.getElementById("PRINTER_BACK").onclick = send_data;
document.getElementById("PRINTER_HOMEXY").onclick = send_data;
document.getElementById("PRINTER_SET_ZERO").onclick = send_data;
document.getElementById("PRINTER_AUTO_ZERO").onclick = send_data;
document.getElementById("StepSelectorForm").onchange = set_step;
// Added August 11th 2025 for WiFi netowrk selection
document.getElementById("password").onclick = function() {
  console.log("Password field clicked");
};

document.getElementById("sendBtn").onclick = function() {
  const ssid = document.getElementById("ssidSelect").value;
  const password = document.getElementById("password").value;

  if (!ssid) {
    document.getElementById("status").textContent = "Please choose a Wi‑Fi network.";
    return;
  }

  const msg = { type: "wifi_config", ssid: ssid, password: password };
  ws.send(JSON.stringify(msg));
  document.getElementById("status").textContent = "Sent Wi‑Fi credentials.";
};

// Function to request Wi-Fi list
function requestWifiList() {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send("RequestWifiList");
    console.log("Requested Wi-Fi list");
  } else {
    console.error("WebSocket not open. Cannot request Wi-Fi list.");
  }
}

// End of 11th August addition 


var step = 0.1
function set_step(){
 const data=document.getElementById("StepSelectorForm").elements ;
 for (let i = 0; i < data.length; i++) { // avoid the first element
	if(data[i].checked == true) {
	step=data[i].value
	//alert("Step selected is: "+step)	
	}
 }
}

var slider = document.getElementById("PUMPSPEED");
var output = document.getElementById("PUMPSPEEDINDICATOR");
var slider1 = document.getElementById("CURRENTSET");
var output1 = document.getElementById("CURRENTSETINDICATOR");
output.innerHTML = slider.value;
output1.innerHTML = slider1.value;

function get_data() {
    ws.send("request_messages");
}

function send_data(){
    switch(window.event.target.id) {
        case "PRINTER_UP":
        case "PRINTER_DOWN":
        case "PRINTER_LEFT":
        case "PRINTER_RIGHT":
        case "PRINTER_BACK":
        case "PRINTER_FORWARD":
		// step contains the selected movement size via the radio buttons
		ws.send(window.event.target.id+": "+step)
        //alert("PRINTER MOVE: "+window.event.target.id+" by: "+step) ;
        break ;
        case "PRINTER_HOMEXY":
        case "PRINTER_HOMEZ":
        case "PRINTER_SET_ZERO":
        case "PRINTER_AUTO_ZERO":
		ws.send(window.event.target.id)
        // alert("PRINTER MOVE: "+window.event.target.id) ;
        break ;
		// pump controls
        case "PUMPSPEED":
        document.getElementById("PUMPSPEEDINDICATOR").innerHTML=window.event.target.value ;
		ws.send("PUMP_SET_SPEED: "+window.event.target.value)
		//alert("PUMP SPEED SET TO: "+window.event.target.value) ;
        break
        case "PUMPSTATE":
        if (window.event.target.checked == true) {
          text2.style.display = "block";
          text3.style.display = "none" ; }
        else {
          text3.style.display = "block";
          text2.style.display = "none" ; }
		ws.send("PUMP_SET_RUN: "+window.event.target.checked)
		//alert(window.event.target.id+": "+window.event.target.checked);
        break ;
        case "PUMPDIR":
        if (window.event.target.checked == true) {
          text.style.display = "block";
          text1.style.display = "none" ; }
        else {
          text1.style.display = "block";
          text.style.display = "none" ; }
		ws.send("PUMP_SET_DIR: "+window.event.target.checked)
		//alert(window.event.target.id+": "+window.event.target.checked);
        break ;
		// gen controls
		case "CURRENTSET":
        document.getElementById("CURRENTSETINDICATOR").innerHTML=window.event.target.value ;
		ws.send("GEN_SET_CURRENT: "+window.event.target.value)
		//alert("CURRENT VALUE SET TO: "+window.event.target.value) ;
        break
        case "GENSTATE":
        if (window.event.target.checked == true) {
          Gtext2.style.display = "block";
          Gtext3.style.display = "none" ; }
        else {
          Gtext3.style.display = "block";
          Gtext2.style.display = "none" ; }
		ws.send("GEN_SET_RUN: "+window.event.target.checked)
		//alert(window.event.target.id+": "+window.event.target.checked);
        break ;
        case "GENVOLT":
        if (window.event.target.checked == true) {
          Gtext.style.display = "block";
          Gtext1.style.display = "none" ; }
        else {
          Gtext1.style.display = "block";
          Gtext.style.display = "none" ; }
		 ws.send("GEN_SET_HV: "+window.event.target.checked)
		//alert(window.event.target.id+": "+window.event.target.checked);
        break ;
		// print controls
        case "STARTPRINT":
        ws.send("START_PRINT: "+"COMMAND")
        //alert("PRESSED: "+window.event.target.id+" WITH TARGET: "+document.getElementById("PRINTABLEFILES").value);
        break ;
        case "PRINTABLEFILES":
        ws.send("SELECT: "+document.getElementById("PRINTABLEFILES").value)
        //alert("Selected: "+window.event.target.value);
		if(window.event.target.value == "V0") {
			document.getElementById("STARTPRINT").setAttribute("disabled","disabled") }
		else {
			document.getElementById("STARTPRINT").removeAttribute("disabled"); }
        break ;
        case "UPLOAD" :
        /* here we actually transmit only the file index in our list (corresponding to the index on the server) 
        and not the actual file name */
        //alert("UPLOAD: "+document.getElementById('myFile').value.replace("C:\\fakepath\\","" )+document.getElementById('myFile').files[0].name)        
        ws.send("FILE_NAME: "+document.getElementById('myFile').value.replace("C:\\fakepath\\","" ))
        ws.send(document.getElementById('myFile').files[0])
        break ;
        default:
        alert("Called by: "+window.event.target.id) ;    
    }
}

function populateNetworks(list) {
  ssidSelect.innerHTML = '';
  if (!Array.isArray(list) || list.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No networks found';
    ssidSelect.appendChild(opt);
    ssidSelect.disabled = true;
    return;
  }
  ssidSelect.disabled = false;
  list.sort((a,b) => (b.rssi ?? 0) - (a.rssi ?? 0) || String(a.ssid).localeCompare(String(b.ssid)));
  for (const net of list) {
    const opt = document.createElement('option');
    opt.value = net.ssid;
    opt.textContent = net.ssid; // security/RSSI appended if present
    ssidSelect.appendChild(opt);
  }
}


<!-- let ws = new WebSocket("ws://127.0.0.1:8080"); -->
<!-- let ws = new WebSocket("ws://raspberrypi2b.local:8080"); -->
ws.onmessage = function(message) {
    let index = message.data.indexOf("DIR: ");
    let index_1 = message.data.indexOf("ELECTRICALS: ");
    let index_2 = message.data.indexOf("{\"type\": ")
    if (index==0) { 
        var myJSON=message.data.substr(5)
        var myObj = JSON.parse(myJSON)
        //document.getElementById('V0').text=myObj.V0 never changes
		document.getElementById('V0').text="Select file"
        document.getElementById('V1').text=myObj.V1
        document.getElementById('V2').text=myObj.V2
        document.getElementById('V3').text=myObj.V3
        document.getElementById('V4').text=myObj.V4
        document.getElementById('V5').text=myObj.V5
        document.getElementById('V6').text=myObj.V6
        document.getElementById('V7').text=myObj.V7
        document.getElementById('V8').text=myObj.V8
        document.getElementById('V9').text=myObj.V9
        document.getElementById('V10').text=myObj.V10
    }
    if (index_1==0) { 
        var myJSON=message.data.substr(13)
        //alert(myJSON)
        var myObj = JSON.parse(myJSON)
        //alert("getting: "+myObj.HV_Voltage+" "+myObj.DR_Voltage+" "+myObj.Current)
        document.getElementById("HV_Voltage").innerHTML="		"+myObj.HV_Voltage+" V";
        document.getElementById("DR_Voltage").innerHTML="		"+myObj.DR_Voltage+" V" ;
        document.getElementById("Current").innerHTML="		"+myObj.Current+" mA";
    }
    if (index_2==0) {
    console.log("network SSIDs received");
    let msg;
    try { 
      msg = JSON.parse(message.data); 
      } catch { 
         console.log('Non-JSON message ignored'); 
         return; 
         }
    switch (msg.type) {
    case 'wifi_scan_result':
      populateNetworks(msg.networks || []);
      // statusEl.textContent = `Found ${msg.networks?.length || 0} network(s).`;
      // statusEl.className = 'status';
      //log(`scan → ${msg.networks?.length || 0} networks`);
      break;
     }
    }
}

setInterval(get_data, 1000);
</script>
</body>
</html>
